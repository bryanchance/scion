<mat-card *ngIf="success" class="success">{{ success }}</mat-card>
<mat-card *ngIf="error" class="error">{{ error }}</mat-card>

<div class="flex-container">
    <div class="flex-container-vertical">
        <form class="traffic-policy-form"
            #trafficPolicyForm="ngForm"
            (ngSubmit)="onSubmit()" *ngIf="!formDisabled">
            <mat-form-field>
                <input matInput name="name" [(ngModel)]="trafficPolicy.Name"
                    placeholder="Name" type="text" required />
            </mat-form-field>
            <ng-select matInput placeholder="Traffic Class" name="trafficClass"
                [items]="trafficClasses" bindLabel="Name"
                bindValue="ID" [(ngModel)]="trafficPolicy.TrafficClass"
                required>
                <ng-template ng-option-tmp let-item="item">
                    {{ item.Name }}: {{ item.condString }}
                </ng-template>
            </ng-select>
            <button mat-icon-button type="submit"
                [disabled]="trafficPolicyForm.invalid ||
                !trafficPolicy.PathPolicies.length">
                <mat-icon>save</mat-icon>
            </button>
        </form>
        <div class="flex-container-left">
            <mat-list dense class="selected-path-policies">
                <div>Path Policies</div>
                <mat-list-item *ngIf="!trafficPolicy.PathPolicies ||
                    trafficPolicy.PathPolicies.length == 0">
                    <span class="policy-hint">You need to add at least one
                        path policy!</span>
                </mat-list-item>
                <mat-list-item *ngFor="let pathPolicy of
                    trafficPolicy.PathPolicies; let idx= index">
                    <span class="name">{{ idx + 1 }}: {{ pathPolicy }}</span>
                    <button mat-icon-button
                        (click)="trafficPolicy.PathPolicies.swap(idx, idx -
                        1)" *ngIf="idx != 0">
                        <mat-icon>keyboard_arrow_up</mat-icon>
                    </button>
                    <button mat-icon-button
                        (click)="trafficPolicy.PathPolicies.swap(idx, idx +
                        1)" *ngIf="idx != trafficPolicy.PathPolicies.length
                        - 1 &&
                        trafficPolicy.PathPolicies.length> 1
                        ">
                        <mat-icon>keyboard_arrow_down</mat-icon>
                    </button>
                    <button mat-icon-button (click)="removePathPolicy(idx)">
                        <mat-icon>delete</mat-icon>
                    </button>
                </mat-list-item>
            </mat-list>
            <div class="all-path-policies">
                <p>Add Path Policy</p>
                <mat-form-field *ngIf="pathPolicies?.length> 4">
                    <input matInput name="pathPolicies"
                        (ngModelChange)="searchSel= $event;
                        searchPathPolicy()"
                        [(ngModel)]="searchPP" placeholder="Search"
                        type="text" />
                </mat-form-field>
                <mat-list dense>
                    <mat-list-item *ngFor="let pathPolicy of
                        (filteredPathPolicies | slice: 0:4)">
                        <div *ngIf="pathPolicy.Policy">
                            <button mat-icon-button
                                (click)="addPathPolicy(pathPolicy.Name)">
                                <mat-icon>add_box</mat-icon>
                            </button>
                            <span>{{ pathPolicy.Name }}</span>
                        </div>
                    </mat-list-item>
                </mat-list>
            </div>
        </div>
    </div>

    <mat-card class="help">
        <mat-card-header>
            <mat-card-title>Traffic Policies</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <p>
                A traffic policy references a traffic class and specifies a list
                of SCION path
                policies in descending priority. If a path policy is not
                available (i.e., due to no
                paths matching the policy), the next policy is used.
            </p>
        </mat-card-content>
    </mat-card>
</div>

<div class="flex-container-vertical">
    <mat-list class="traffic-policies">
        <mat-list-item *ngFor="let trafficPolicy of trafficPolicies; let idx=
            index">
            <div class="name">
                <span>{{ trafficPolicy.Name }}</span> <br />
                <span class="small" *ngFor="let pathPolicy of
                    trafficPolicy.PathPolicies; last as isLast">
                    <span>{{ pathPolicy }}</span> <span *ngIf="!isLast">,&nbsp;</span>
                </span>
            </div>
            <span class="traffic-class">{{
                getTrafficClass(trafficPolicy.TrafficClass)?.Name
                }}</span>
            <button *ngIf="!formDisabled" mat-icon-button (click)="edit(idx)">
                <mat-icon>edit</mat-icon>
            </button>
            <button *ngIf="!formDisabled" mat-icon-button (click)="delete(idx)">
                <mat-icon>delete</mat-icon>
            </button>
        </mat-list-item>
    </mat-list>
</div>
